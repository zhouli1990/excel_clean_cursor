<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>表格数据清洗</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        /* Style to make nested accordions look slightly different or indented */
        #settingsAccordion .accordion-body .accordion {
            margin-left: 15px;
            margin-right: 15px;
        }

        #settingsAccordion .accordion-body .card {
            margin-left: 15px;
            margin-right: 15px;
        }

        /* Added CSS for highlighting */
        /* Ensure background colors have enough contrast or adjust text color */
        .table-success {
            background-color: #e6ffed !important;
        }

        /* Lighter green */
        .table-danger {
            background-color: #f8d7da !important;
        }

        .table-danger td {
            text-decoration: line-through;
            color: #6c757d;
        }

        /* Strikethrough for deleted rows */
        .table-warning {
            background-color: #fff9e0 !important;
        }

        /* Lighter yellow */

        .cell-modified {
            font-weight: bold;
            color: red;
            /* Optional: Add a more distinct background or border */
            /* background-color: #ffeeba; */
            /* border: 1px dashed #ffc107 !important; */
        }

        /* Style for pagination controls */
        .diff-pagination-controls {
            display: inline-flex;
            /* Align items nicely */
            align-items: center;
        }

        /* Reduce vertical padding on table cells for denser look */
        .table-sm td,
        .table-sm th {
            padding: 0.3rem;
        }
    </style>
</head>

<body>
    <!-- 日志导出按钮（仅开发/排障使用，可隐藏或放到调试面板） -->
    <div style="position:fixed; top:10px; right:10px; z-index:9999;">
        <button id="export-log-btn" class="btn btn-sm btn-secondary">导出前端日志</button>
    </div>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>表格数据清洗</h1>
            <a href="/history" class="btn btn-outline-secondary">查看历史记录</a>
        </div>
        <p>上传一个或多个Excel（.xlsx、.xls）或CSV（.CSV）文件，并拉取飞书多维表格数据以进行整合和标准化，最后更新飞书多维表格。</p>
        <!-- 总配置区域 -->
        <div class="accordion mb-3" id="settingsAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="settingsHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseSettings" aria-expanded="false" aria-controls="collapseSettings">
                        配置选项 (点击展开/折叠)
                    </button>
                </h2>
                <div id="collapseSettings" class="accordion-collapse collapse" aria-labelledby="settingsHeading"
                    data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">

                        <!-- LLM 高级配置 -->
                        <div class="accordion mb-3" id="configAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="configHeading">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseConfig" aria-expanded="false"
                                        aria-controls="collapseConfig">
                                        LLM 处理配置 (点击展开/折叠)
                                    </button>
                                </h2>
                                <div id="collapseConfig" class="accordion-collapse collapse"
                                    aria-labelledby="configHeading" data-bs-parent="#configAccordion">
                                    <div class="accordion-body">
                                        <div class="mb-3">
                                            <label class="form-label">目标列名 (Target Columns):</label>
                                            <div id="target-columns-container">
                                                {% for column_name in default_llm_config.TARGET_COLUMNS %}
                                                <div class="input-group mb-2">
                                                    <input type="text" class="form-control target-column-input"
                                                        placeholder="输入目标列名" value="{{ column_name }}">
                                                    {% if loop.index > 1 %} {# 第一个不允许移除 #}
                                                    <button class="btn btn-outline-danger remove-column-btn"
                                                        type="button">移除</button>
                                                    {% endif %}
                                                </div>
                                                {% else %}
                                                <!-- 如果默认列表为空，至少显示一个输入框 -->
                                                <div class="input-group mb-2">
                                                    <input type="text" class="form-control target-column-input"
                                                        placeholder="输入目标列名" value="">
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <button class="btn btn-outline-secondary btn-sm mt-2" type="button"
                                                id="add-column-btn">+
                                                添加列名</button>
                                            <div class="form-text">指定最终输出 Excel 文件中需要包含的列标题。</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="api-key" class="form-label">DeepSeek API Key:</label>
                                            <input type="password" class="form-control" id="api-key"
                                                placeholder="输入您的 DeepSeek API Key (例如 sk-xxxx)"
                                                value="{{ default_llm_config.DEEPSEEK_API_KEY }}">
                                            <div class="form-text">您的 DeepSeek API 密钥。如果留空，将尝试使用服务器端的默认配置 (若有)。</div>
                                        </div>

                                        <!-- 阿里云百炼API配置 -->
                                        <div class="mb-3">
                                            <label for="dashscope-api-key" class="form-label">阿里云百炼 API Key:</label>
                                            <input type="password" class="form-control" id="dashscope-api-key"
                                                placeholder="输入您的阿里云百炼 API Key (例如 sk-xxxx)"
                                                value="{{ default_llm_config.DASHSCOPE_API_KEY }}">
                                            <div class="form-text">您的阿里云百炼 API 密钥。此配置优先级高于DeepSeek API
                                                Key，如果有效将使用百炼批处理接口。</div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="bailian-model-name" class="form-label">百炼模型名称:</label>
                                                <input type="text" class="form-control" id="bailian-model-name"
                                                    placeholder="例如: qwen-turbo-latest"
                                                    value="{{ default_llm_config.BAILIAN_MODEL_NAME }}">
                                                <div class="form-text">百炼API使用的模型名称，默认qwen-turbo-latest</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="bailian-completion-window" class="form-label">完成窗口:</label>
                                                <input type="text" class="form-control" id="bailian-completion-window"
                                                    value="{{ default_llm_config.BAILIAN_COMPLETION_WINDOW }}">
                                                <div class="form-text">批处理完成窗口，例如"24h"</div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="batch-size" class="form-label">批处理大小 (Batch Size):</label>
                                                <input type="number" class="form-control" id="batch-size"
                                                    value="{{ default_llm_config.BATCH_SIZE }}" min="1">
                                                <div class="form-text">每次调用 API 处理的行数。</div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="max-tokens" class="form-label">最大完成 Token 数 (Max
                                                    Tokens):</label>
                                                <input type="number" class="form-control" id="max-tokens"
                                                    value="{{ default_llm_config.MAX_COMPLETION_TOKENS }}" min="100">
                                                <div class="form-text">限制模型单次生成的最大 Token 数。</div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="api-timeout" class="form-label">API 超时时间 (秒):</label>
                                                <input type="number" class="form-control" id="api-timeout"
                                                    value="{{ default_llm_config.API_TIMEOUT }}" min="10">
                                                <div class="form-text">调用 API 等待响应的最长时间。</div>
                                            </div>
                                        </div>
                                        <!-- 移除旧的保存按钮 -->
                                        <!-- <button type="button" class="btn btn-success btn-sm" id="save-llm-config-btn">保存此部分为默认值</button> -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 飞书配置 -->
                        <div class="accordion mb-3" id="feishuConfigAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="feishuConfigHeading">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseFeishuConfig" aria-expanded="false"
                                        aria-controls="collapseFeishuConfig">
                                        飞书数据源配置 (点击展开/折叠)
                                    </button>
                                </h2>
                                <div id="collapseFeishuConfig" class="accordion-collapse collapse"
                                    aria-labelledby="feishuConfigHeading" data-bs-parent="#feishuConfigAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="feishu-app-id" class="form-label">飞书 App ID:</label>
                                                <input type="text" class="form-control" id="feishu-app-id"
                                                    value="{{ default_feishu_config.APP_ID }}">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="feishu-app-secret" class="form-label">飞书 App Secret:</label>
                                                <input type="password" class="form-control" id="feishu-app-secret"
                                                    value="{{ default_feishu_config.APP_SECRET }}">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="feishu-app-token" class="form-label">飞书 Base App Token:</label>
                                            <input type="text" class="form-control" id="feishu-app-token"
                                                value="{{ default_feishu_config.APP_TOKEN }}">
                                            <div class="form-text">多维表格的 App Token (不是 Table Token)。</div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">来源飞书 Table IDs (用于读取和更新/删除):</label>
                                            <div id="feishu-table-ids-container">
                                                {% for table_id in default_feishu_config.TABLE_IDS %}
                                                <div class="input-group mb-2">
                                                    <input type="text" class="form-control feishu-table-id-input"
                                                        placeholder="输入 Table ID" value="{{ table_id }}">
                                                    <button class="btn btn-outline-danger remove-feishu-table-id-btn"
                                                        type="button">移除</button>
                                                </div>
                                                {% else %}
                                                <div class="input-group mb-2">
                                                    <input type="text" class="form-control feishu-table-id-input"
                                                        placeholder="输入 Table ID" value="">
                                                    <button class="btn btn-outline-danger remove-feishu-table-id-btn"
                                                        type="button">移除</button>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <button class="btn btn-outline-secondary btn-sm mt-2" type="button"
                                                id="add-feishu-table-id-btn">+ 添加来源 Table ID</button>
                                            <div class="form-text">需要从中拉取数据并进行更新/删除操作的表格。</div>
                                        </div>
                                        <!-- Updated: Add Target Table IDs List -->
                                        <div class="mb-3">
                                            <label class="form-label">目标飞书 Table IDs (用于新增写入):</label>
                                            <div id="feishu-add-target-ids-container"> <!-- Changed ID -->
                                                {% for add_table_id in default_feishu_config.ADD_TARGET_TABLE_IDS %}
                                                <div class="input-group mb-2">
                                                    <input type="text" class="form-control feishu-add-target-id-input"
                                                        placeholder="输入新增专用 Table ID" value="{{ add_table_id }}">
                                                    <button
                                                        class="btn btn-outline-danger remove-feishu-add-target-id-btn"
                                                        type="button">移除</button>
                                                </div>
                                                {% else %}
                                                <!-- Display one empty input if the list is empty -->
                                                <div class="input-group mb-2">
                                                    <input type="text" class="form-control feishu-add-target-id-input"
                                                        placeholder="输入新增专用 Table ID" value="">
                                                    <button
                                                        class="btn btn-outline-danger remove-feishu-add-target-id-btn"
                                                        type="button">移除</button>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <button class="btn btn-outline-secondary btn-sm mt-2" type="button"
                                                id="add-feishu-add-target-id-btn">+ 添加目标 Table ID</button>
                                            <!-- Changed ID -->
                                            <div class="form-text">
                                                指定用于新增记录的表格。若填写多个，将按顺序检查行数限制，写入第一个有足够空间的表格。若不填，则使用来源 Table ID的第一个。</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 后处理操作 -->
                        <div class="card mb-3">
                            <div class="card-header">后处理操作配置 (在数据合并后执行)</div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input post-process-check" type="checkbox"
                                            value="check_duplicate_phones" id="check_duplicate_phones" checked
                                            data-target-selects="#post-phone-col-1-select">
                                        <label class="form-check-label" for="check_duplicate_phones">
                                            校验重复手机号 (在备注列标记)
                                        </label>
                                    </div>
                                    <div class="mt-2" id="post-phone-col-1-select-container" style="display: block;">
                                        <select class="form-select form-select-sm post-process-select"
                                            id="post-phone-col-1-select" name="post_phone_col_for_dup_phones">
                                            <option value="" selected>-- 请选择用于校验的"电话" 列 --</option>
                                            <!-- Options will be populated by JS -->
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input post-process-check" type="checkbox"
                                            value="check_duplicate_companies" id="check_duplicate_companies" checked
                                            data-target-selects="#post-phone-col-2-select, #post-company-col-select">
                                        <label class="form-check-label" for="check_duplicate_companies">
                                            校验手机号+公司名重复 & 关联公司名(LLM)检查
                                        </label>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-6" id="post-phone-col-2-select-container"
                                            style="display: block;">
                                            <select class="form-select form-select-sm post-process-select"
                                                id="post-phone-col-2-select" name="post_phone_col_for_dup_comp">
                                                <option value="" selected>-- 请选择"电话" 列 --</option>
                                                <!-- Options will be populated by JS -->
                                            </select>
                                        </div>
                                        <div class="col-md-6" id="post-company-col-select-container"
                                            style="display: block;">
                                            <select class="form-select form-select-sm post-process-select"
                                                id="post-company-col-select" name="post_company_col_for_dup_comp">
                                                <option value="" selected>-- 请选择"公司" 列 --</option>
                                                <!-- Options will be populated by JS -->
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <!-- *** 新增：手机号格式校验 *** -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input post-process-check" type="checkbox"
                                            value="validate_phone_format" id="validate_phone_format" checked
                                            data-target-selects="#post-phone-col-3-select">
                                        <label class="form-check-label" for="validate_phone_format">
                                            校验手机号格式 (11位数字，在备注列标记错误)
                                        </label>
                                    </div>
                                    <div class="mt-2" id="post-phone-col-3-select-container" style="display: block;">
                                        <select class="form-select form-select-sm post-process-select"
                                            id="post-phone-col-3-select" name="post_phone_col_for_regex">
                                            <option value="" selected>-- 请选择用于格式校验的"电话" 列 --</option>
                                            <!-- Options will be populated by JS -->
                                        </select>
                                    </div>
                                </div>
                                <!-- *** 新增结束 *** -->
                            </div>
                        </div>

                        <!-- 统一保存按钮 -->
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success" id="save-all-settings-btn">保存所有设置为默认值</button>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        <!-- 数据清洗功能区（样式与同步飞书一致） -->
        <div class="mb-4 p-3 border rounded">
            <h4>数据清洗</h4>
            <form id="upload-form" enctype="multipart/form-data" class="mb-4">
                <div class="mb-3">
                    <label class="form-label fw-bold">选择文件</label><br>
                    <button type="button" class="btn btn-primary mb-2" id="select-files-btn">选择文件</button>
                    <input type="file" class="visually-hidden" id="file-input" name="files[]" multiple required
                        accept=".xlsx,.xls,.csv">
                    <div id="selected-files-list" class="text-muted small"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">数据清洗</label><br>
                    <button type="submit" class="btn btn-primary">开始处理</button>
                </div>
            </form>
            <!-- 处理状态/进度条区域 -->
            <div id="progress-container" class="progress-container mt-4">
                <div id="status-message" class="alert alert-info">等待上传文件...</div>
                <div class="progress mb-2">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                        role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%
                    </div>
                </div>
                <div id="result-link-container"></div>
            </div>
        </div>

        <!-- 同步飞书功能区 -->
        <div class="mb-4 p-3 border rounded">
            <h4>同步飞书（可跳过前序步骤）</h4>
            <p class="text-muted">上传符合要求的Excel文件，直接导入到飞书多维表格，无需通过LLM处理。</p>
            <form id="direct-import-form" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="direct-import-file-input" class="form-label fw-bold">选择文件:</label><br>
                    <button type="button" class="btn btn-secondary mb-2"
                        id="select-direct-import-file-btn">选择文件</button>
                    <input type="file" class="visually-hidden" id="direct-import-file-input" accept=".xlsx,.xls,.csv">
                    <div id="selected-direct-import-file-list" class="text-muted small mb-2">尚未选择文件</div>
                    <button type="button" class="btn btn-warning" id="upload-direct-import-btn"
                        disabled>上传并准备导入</button>
                </div>
            </form>
            <div id="direct-import-status" class="alert alert-info mt-2" style="display: none;"></div>
            <div class="mt-3">
                <button type="button" class="btn btn-warning" id="direct-sync-feishu-btn" disabled>同步到飞书</button>
                <span id="direct-sync-status" class="ms-2"></span>
            </div>
        </div>

    </div> <!-- End container -->

    <script>
        /* ---------- 前端日志封装与导出 ---------- */
        const logBuffer = [];
        function pushLog(msg, type = 'log') {
            const line = `[${new Date().toISOString()}] ${msg}`;
            logBuffer.push(line);
            // 同时输出到控制台
            if (type === 'error') console.error(line);
            else if (type === 'warn') console.warn(line);
            else console.log(line);
        }

        // 重写全局 fetch 以统一日志
        const _origFetch = window.fetch.bind(window);
        window.fetch = async function (url, options = {}) {
            const start = Date.now();
            pushLog(`[FETCH-START] url=${url}`, 'log');
            try {
                const resp = await _origFetch(url, options);
                const dur = Date.now() - start;
                pushLog(`[FETCH-SUCCESS] url=${url} status=${resp.status} duration=${dur}ms`, 'log');
                return resp;
            } catch (err) {
                const dur = Date.now() - start;
                pushLog(`[FETCH-FAIL] url=${url} duration=${dur}ms error=${err}`, 'error');
                throw err;
            }
        };

        // 导出日志到文件
        function exportLogs() {
            const blob = new Blob([logBuffer.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `frontend_logs_${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        document.getElementById('export-log-btn').addEventListener('click', exportLogs);

        // 捕获全局未处理异常
        window.addEventListener('unhandledrejection', e => pushLog(`[UNHANDLED-REJECTION] ${e.reason}`, 'error'));
        window.addEventListener('error', e => pushLog(`[JS-ERROR] ${e.message} ${e.error || ''}`, 'error'));
        /* ---------- 日志封装与导出结束 ---------- */

        // DOM element references
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const statusMessage = document.getElementById('status-message');
        const resultLinkContainer = document.getElementById('result-link-container');
        // LLM Config
        const targetColumnsContainer = document.getElementById('target-columns-container');
        const addColumnBtn = document.getElementById('add-column-btn');
        const apiKeyInput = document.getElementById('api-key');
        const batchSizeInput = document.getElementById('batch-size');
        const maxTokensInput = document.getElementById('max-tokens');
        const apiTimeoutInput = document.getElementById('api-timeout');
        // 阿里云百炼API配置
        const dashscopeApiKeyInput = document.getElementById('dashscope-api-key');
        const bailianModelNameInput = document.getElementById('bailian-model-name');
        const bailianCompletionWindowInput = document.getElementById('bailian-completion-window');
        // Feishu Config
        const feishuAppIdInput = document.getElementById('feishu-app-id');
        const feishuAppSecretInput = document.getElementById('feishu-app-secret');
        const feishuAppTokenInput = document.getElementById('feishu-app-token');
        const feishuTableIdsContainer = document.getElementById('feishu-table-ids-container');
        const addFeishuTableIdBtn = document.getElementById('add-feishu-table-id-btn');
        // New references for Add Target IDs
        const feishuAddTargetIdsContainer = document.getElementById('feishu-add-target-ids-container');
        const addFeishuAddTargetIdBtn = document.getElementById('add-feishu-add-target-id-btn');
        // Post-processing Config
        const postProcessCheckboxes = document.querySelectorAll('.post-process-check');
        const postProcessSelects = document.querySelectorAll('.post-process-select');
        // Save Button
        const saveAllSettingsBtn = document.getElementById('save-all-settings-btn');
        // New elements for file list display
        const selectFilesBtn = document.getElementById('select-files-btn');
        const selectedFilesListDiv = document.getElementById('selected-files-list');

        let intervalId = null; // To store the interval timer
        let currentTaskId = null; // Store the current task ID

        // Store default post-processing columns from backend
        const defaultPostProcessingCols = {{ default_post_processing_cols| tojson | safe }};

        // 直接导入文件功能
        const selectDirectImportFileBtn = document.getElementById('select-direct-import-file-btn');
        const directImportFileInput = document.getElementById('direct-import-file-input');
        const selectedDirectImportFileList = document.getElementById('selected-direct-import-file-list');
        const uploadDirectImportBtn = document.getElementById('upload-direct-import-btn');
        const directImportStatus = document.getElementById('direct-import-status');
        // 添加直接导入同步按钮的引用
        const directSyncFeishuBtn = document.getElementById('direct-sync-feishu-btn');
        const directSyncStatusSpan = document.getElementById('direct-sync-status');

        // 直接导入文件的任务ID
        let currentDirectImportTaskId = null;

        // --- Event Listeners ---
        uploadForm.addEventListener('submit', handleUploadSubmit);
        addColumnBtn.addEventListener('click', handleAddTargetColumn);
        targetColumnsContainer.addEventListener('click', handleRemoveTargetColumn);
        targetColumnsContainer.addEventListener('input', handleTargetColumnInput); // Re-add listener for dynamic updates
        addFeishuTableIdBtn.addEventListener('click', handleAddFeishuTableId);
        feishuTableIdsContainer.addEventListener('click', handleRemoveFeishuTableId);
        // New listeners for Add Target IDs
        addFeishuAddTargetIdBtn.addEventListener('click', handleAddFeishuAddTargetId); // Use new handler
        feishuAddTargetIdsContainer.addEventListener('click', handleRemoveFeishuAddTargetId); // Use new handler

        postProcessCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', handlePostCheckboxChange);
        });
        saveAllSettingsBtn.addEventListener('click', saveAllSettingsToServer); // Bind the new save button
        document.addEventListener('DOMContentLoaded', initializePage); // Init on page load
        // Listener for the custom select files button
        selectFilesBtn.addEventListener('click', () => fileInput.click());
        // Listener for the actual file input change to update the list
        fileInput.addEventListener('change', displaySelectedFiles);

        // 绑定直接导入文件的选择按钮事件
        selectDirectImportFileBtn.addEventListener('click', function () {
            directImportFileInput.click();
        });

        // 直接导入文件选择变化时的事件
        directImportFileInput.addEventListener('change', function () {
            if (this.files.length > 0) {
                const file = this.files[0];
                selectedDirectImportFileList.textContent = `已选择: ${file.name} (${formatFileSize(file.size)})`;
                uploadDirectImportBtn.disabled = false;
            } else {
                selectedDirectImportFileList.textContent = '尚未选择文件';
                uploadDirectImportBtn.disabled = true;
            }
        });

        // 添加直接导入同步按钮的点击事件
        directSyncFeishuBtn.addEventListener('click', handleDirectSyncToFeishu);

        // 上传直接导入文件的事件
        uploadDirectImportBtn.addEventListener('click', function () {
            if (!directImportFileInput.files.length) {
                alert('请先选择一个文件');
                return;
            }

            const file = directImportFileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            // 新增：同步目标列配置
            const targetColumns = typeof getTargetColumns === 'function' ? getTargetColumns() : [];
            formData.append('config_target_columns', JSON.stringify(targetColumns));

            // 显示上传中状态
            directImportStatus.textContent = '文件上传中...';
            directImportStatus.style.display = 'block';
            directImportStatus.className = 'alert alert-info mt-2';
            uploadDirectImportBtn.disabled = true;

            // 发送到新的智能上传路由
            fetch('/upload_new_or_associate_file', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        directImportStatus.textContent = data.message;
                        directImportStatus.className = 'alert alert-success mt-2';

                        // 存储任务ID，用于后续同步操作
                        currentDirectImportTaskId = data.task_id;

                        // 启用直接导入同步按钮
                        directSyncFeishuBtn.disabled = false;

                        // 更新界面状态提示：准备直接导入
                        directImportStatus.innerHTML = `文件已上传成功！<br>任务ID: ${data.task_id}<br>您可以点击"同步到飞书"按钮将数据导入到飞书多维表格。`;
                    } else {
                        directImportStatus.textContent = `错误: ${data.error}`;
                        directImportStatus.className = 'alert alert-danger mt-2';
                        uploadDirectImportBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('直接导入文件上传失败:', error);
                    directImportStatus.textContent = `上传失败: ${error.message || '未知错误'}`;
                    directImportStatus.className = 'alert alert-danger mt-2';
                    uploadDirectImportBtn.disabled = false;
                });
        });

        // --- Functions ---

        // Initialize page elements
        function initializePage() {
            console.log("Initializing page...");
            // console.log("Default Post Processing Cols:", defaultPostProcessingCols);
            updatePostProcessSelects(); // Populate selects based on initial target columns and defaults

            // Ensure initial visibility of select dropdowns based on checkbox state
            // Re-query the checkboxes *after* potentially adding new ones dynamically or on page load
            document.querySelectorAll('.post-process-check').forEach(cb => {
                handlePostCheckboxChange({ target: cb }); // Simulate event on load for all checks
            });

            resetProgress(); // Ensure progress bar is hidden initially
        }

        // Handle file upload form submission
        async function handleUploadSubmit(event) {
            event.preventDefault();
            const filesToUpload = fileInput.files;

            // Store Task ID globally when upload starts
            currentTaskId = null; // Reset task ID

            resetProgress();
            progressContainer.style.display = 'block';
            statusMessage.textContent = 'Uploading files...';

            if (!filesToUpload || filesToUpload.length === 0) {
                showErrorStatus('错误: 未选择任何文件。');
                return;
            }

            const formData = new FormData();

            for (const file of filesToUpload) {
                formData.append('files[]', file);
            }

            // Append all config data
            appendConfigToFormData(formData);

            // Don't clear fileInput value here, allow retry if needed
            // fileInput.value = ''; 

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                });
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `HTTP error! status: ${response.status}`);
                }

                if (result.task_id) {
                    currentTaskId = result.task_id; // Store the task ID
                    statusMessage.textContent = 'Upload successful. Starting processing...';
                    pollProgress(currentTaskId);
                } else {
                    throw new Error('No task ID received from server.');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showErrorStatus(`Upload failed: ${error.message}`);
                currentTaskId = null; // Clear task ID on error
            }
        }

        // Append all configuration values to FormData (Updated)
        function appendConfigToFormData(formData) {
            // LLM Config
            const targetColumns = getTargetColumns();
            formData.append('config_target_columns', JSON.stringify(targetColumns));
            formData.append('config_api_key', apiKeyInput.value.trim());
            formData.append('config_batch_size', batchSizeInput.value);
            formData.append('config_max_tokens', maxTokensInput.value);
            formData.append('config_api_timeout', apiTimeoutInput.value);

            // 添加阿里云百炼API相关配置
            formData.append('config_dashscope_api_key', dashscopeApiKeyInput.value.trim());
            formData.append('config_bailian_model_name', bailianModelNameInput.value.trim());
            formData.append('config_bailian_completion_window', bailianCompletionWindowInput.value.trim());

            // Feishu Config
            formData.append('feishu_app_id', feishuAppIdInput.value.trim());
            formData.append('feishu_app_secret', feishuAppSecretInput.value.trim());
            formData.append('feishu_app_token', feishuAppTokenInput.value.trim());
            const feishuTableIds = getFeishuTableIds();
            formData.append('feishu_table_ids', JSON.stringify(feishuTableIds));
            // Append the new list of Add Target IDs
            const feishuAddTargetIds = getFeishuAddTargetIds(); // New function to get the list
            formData.append('feishu_add_target_table_ids', JSON.stringify(feishuAddTargetIds)); // New field name
            // Post-processing Config
            const postProcessConfig = getPostProcessingConfig();
            formData.append('post_process_config', JSON.stringify(postProcessConfig));
        }

        // Get current target column names
        function getTargetColumns() {
            const targetColumnInputs = targetColumnsContainer.querySelectorAll('.target-column-input');
            return Array.from(targetColumnInputs)
                .map(input => input.value.trim())
                .filter(value => value !== '');
        }

        // Get current Feishu Table IDs
        function getFeishuTableIds() {
            const feishuTableIdInputs = feishuTableIdsContainer.querySelectorAll('.feishu-table-id-input');
            return Array.from(feishuTableIdInputs)
                .map(input => input.value.trim())
                .filter(value => value !== '');
        }

        // New function: Get current Feishu Add Target Table IDs
        function getFeishuAddTargetIds() {
            const addTargetIdInputs = feishuAddTargetIdsContainer.querySelectorAll('.feishu-add-target-id-input');
            return Array.from(addTargetIdInputs)
                .map(input => input.value.trim())
                .filter(value => value !== ''); // Filter out empty strings
        }

        // Get current post-processing configuration (selected checks and columns)
        function getPostProcessingConfig() {
            const config = {};
            // Re-query checkboxes inside the function in case they are added dynamically
            document.querySelectorAll('.post-process-check').forEach(checkbox => {
                if (checkbox.checked) {
                    const checkValue = checkbox.value;
                    config[checkValue] = {};
                    const targetSelectIds = checkbox.dataset.targetSelects;
                    if (targetSelectIds) {
                        targetSelectIds.split(',').forEach(selectId => {
                            const selectElement = document.querySelector(selectId.trim());
                            if (selectElement && selectElement.value) {
                                config[checkValue][selectElement.name] = selectElement.value;
                            }
                        });
                    }
                    // Basic validation: Ensure required columns are selected for active checks
                    if (checkValue === 'check_duplicate_phones' && !config[checkValue]['post_phone_col_for_dup_phones']) {
                        console.warn('Post-processing: Duplicate phone check active but column not selected.');
                    }
                    if (checkValue === 'check_duplicate_companies' && (!config[checkValue]['post_phone_col_for_dup_comp'] || !config[checkValue]['post_company_col_for_dup_comp'])) {
                        console.warn('Post-processing: Duplicate company check active but columns not fully selected.');
                    }
                    // Add validation for the new check
                    if (checkValue === 'validate_phone_format' && !config[checkValue]['post_phone_col_for_regex']) {
                        console.warn('Post-processing: Phone format validation active but column not selected.');
                    }
                }
            });
            return config;
        }

        // Poll server for task progress
        function pollProgress(taskId) {
            if (intervalId) clearInterval(intervalId);
            let failCount = 0;

            async function doPoll() {
                try {
                    const response = await fetch(`/progress/${taskId}`);
                    if (!response.ok) {
                        if (response.status === 404) {
                            console.warn(`Task ${taskId} not found. Stopping polling.`);
                            showWarningStatus('Task status unknown or completed.');
                            clearInterval(intervalId);
                            currentTaskId = null;
                            return;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    failCount = 0; // 成功后重置
                    const task = await response.json();
                    updateProgressBar(task.progress);
                    updateStatusMessage(task.status, task.error);

                    // 添加对百炼批处理状态的特殊处理
                    if (task.status === 'BatchProcessing') {
                        // 调用检查百炼批处理状态的API
                        console.log(`检测到百炼批处理任务，调用check_batch_status API检查状态...`);
                        try {
                            const batchResponse = await fetch(`/check_batch_status/${taskId}`);
                            const batchResult = await batchResponse.json();
                            console.log('百炼批处理状态检查结果:', batchResult);

                            if (batchResponse.ok) {
                                if (batchResult.status === 'completed') {
                                    updateStatusMessage('百炼批处理已完成，正在处理结果中...', null);
                                    updateProgressBar(90);
                                } else {
                                    updateStatusMessage(batchResult.message || `百炼批处理中: ${batchResult.status}`, null);
                                }
                            } else {
                                console.warn(`检查百炼批处理状态失败: ${batchResult.error || '未知错误'}`);
                            }
                        } catch (batchError) {
                            console.error('检查百炼批处理状态时发生错误:', batchError);
                        }
                    }

                    if (task.progress >= 100) {
                        clearInterval(intervalId);
                        progressBar.classList.remove('progress-bar-animated');
                        if (task.status === 'Completed' && task.result_file) {
                            showDownloadLink(taskId, task.result_file);
                        } else {
                            if (task.status !== 'Error') {
                                showWarningStatus('处理完成但未找到结果文件。');
                            }
                        }
                    }
                } catch (error) {
                    failCount++;
                    if (failCount < 3) {
                        setTimeout(doPoll, 500); // 500ms后重试
                    } else {
                        console.error('Polling error:', error);
                        showErrorStatus(`Error checking progress: ${error.message}`);
                        clearInterval(intervalId);
                        currentTaskId = null;
                    }
                }
            }

            intervalId = setInterval(doPoll, 2000);
            doPoll(); // 立即执行一次
        }

        // Update progress bar display
        function updateProgressBar(progress) {
            const pct = Math.max(0, Math.min(100, parseInt(progress) || 0));
            progressBar.style.width = `${pct}%`;
            progressBar.textContent = `${pct}%`;
            progressBar.setAttribute('aria-valuenow', pct);
            if (pct < 100) {
                progressBar.classList.add('progress-bar-animated');
            } else {
                progressBar.classList.remove('progress-bar-animated');
            }
        }

        // Update status message display
        function updateStatusMessage(status, error = null) {
            statusMessage.textContent = status;
            if (status === 'Completed') {
                statusMessage.className = 'alert alert-success';
                statusMessage.textContent = '处理完成! 您可以下载结果文件。';
            } else if (status === 'Error') {
                statusMessage.className = 'alert alert-danger';
                statusMessage.textContent = `Processing failed: ${error || 'Unknown error'}`;
            } else if (status === 'BatchProcessing' || status.includes('百炼批处理')) {
                // 添加对百炼批处理状态的特殊样式
                statusMessage.className = 'alert alert-info';
                // 使用带有进度指示的文本
                statusMessage.innerHTML = `${status} <div class="spinner-border spinner-border-sm text-info ms-2" role="status"><span class="visually-hidden">批处理中...</span></div>`;
            } else {
                statusMessage.className = 'alert alert-info';
            }
        }

        function showWarningStatus(message) {
            statusMessage.textContent = message;
            statusMessage.className = 'alert alert-warning';
            updateProgressBar(100); // Mark as done for polling purposes
            clearInterval(intervalId);
        }

        function showErrorStatus(message) {
            statusMessage.textContent = message;
            statusMessage.className = 'alert alert-danger';
            updateProgressBar(0); // Reset progress bar on error
            clearInterval(intervalId);
        }

        // Display download link
        function showDownloadLink(taskId, resultFile) {
            const downloadUrl = `/download/${taskId}/${encodeURIComponent(resultFile)}`;
            // Add link to the main result container *and* the step 3 placeholder if needed
            resultLinkContainer.innerHTML = `<a href="${downloadUrl}" class="btn btn-success" target="_blank">下载最终结果 (${resultFile})</a>`;
        }

        // Reset progress display area
        function resetProgress() {
            progressContainer.style.display = 'none'; // Hide initially
            updateProgressBar(0);
            statusMessage.textContent = '等待上传...';
            statusMessage.className = 'alert alert-info';
            resultLinkContainer.innerHTML = '';
            selectedFilesListDiv.innerHTML = '尚未选择文件'; // Clear file list on reset
            if (intervalId) clearInterval(intervalId);
        }

        // Save all current settings to server as default (Updated)
        async function saveAllSettingsToServer() {
            console.log("Saving all current settings as default...");
            const configToSave = {
                llm_config: {
                    TARGET_COLUMNS: getTargetColumns(),
                    DEEPSEEK_API_KEY: apiKeyInput.value.trim(),
                    BATCH_SIZE: parseInt(batchSizeInput.value) || 160,
                    MAX_COMPLETION_TOKENS: parseInt(maxTokensInput.value) || 8192,
                    API_TIMEOUT: parseInt(apiTimeoutInput.value) || 180,

                    // 添加阿里云百炼API相关配置
                    DASHSCOPE_API_KEY: dashscopeApiKeyInput.value.trim(),
                    BAILIAN_MODEL_NAME: bailianModelNameInput.value.trim(),
                    BAILIAN_COMPLETION_WINDOW: bailianCompletionWindowInput.value.trim(),
                    // 默认保留这些配置，不需要用户手动输入
                    BAILIAN_BASE_URL: "https://dashscope.aliyuncs.com/compatible-mode/v1",
                    BAILIAN_BATCH_ENDPOINT: "/v1/chat/completions"
                },
                feishu_config: {
                    APP_ID: feishuAppIdInput.value.trim(),
                    APP_SECRET: feishuAppSecretInput.value.trim(),
                    APP_TOKEN: feishuAppTokenInput.value.trim(),
                    TABLE_IDS: getFeishuTableIds(),
                    ADD_TARGET_TABLE_IDS: getFeishuAddTargetIds(), // Get the new list
                },
                post_processing_config: getPostProcessingConfig()
            };
            console.log("Sending config to server: ", configToSave);
            try {
                const response = await fetch('/save_config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(configToSave)
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    alert('成功! 所有设置已保存为默认值。下次加载页面时将自动应用。');
                } else {
                    alert(`保存失败: ${result.error || '未知错误'}`);
                    console.error("保存配置失败: ", result);
                }
            } catch (error) {
                alert(`保存配置时发生网络错误: ${error.message}`);
                console.error("保存配置网络错误: ", error);
            }
        }

        // --- Dynamic Form Element Handlers --- (Add handlers for new list) ---

        // Add new target column input
        function handleAddTargetColumn() {
            const newInputGroup = document.createElement('div');
            newInputGroup.className = 'input-group mb-2';
            newInputGroup.innerHTML = `
                <input type="text" class="form-control target-column-input" placeholder="输入目标列名">
                <button class="btn btn-outline-danger remove-column-btn" type="button">移除</button>
            `;
            targetColumnsContainer.appendChild(newInputGroup);
            updatePostProcessSelects(); // Update dependent dropdowns
        }

        // Remove target column input
        function handleRemoveTargetColumn(event) {
            if (event.target.classList.contains('remove-column-btn')) {
                event.target.closest('.input-group').remove();
                updatePostProcessSelects(); // Update dependent dropdowns
            }
        }

        // Handle input change in target column fields
        function handleTargetColumnInput(event) {
            if (event.target.classList.contains('target-column-input')) {
                updatePostProcessSelects();
            }
        }

        // Add new Feishu Table ID input
        function handleAddFeishuTableId() {
            const newInputGroup = document.createElement('div');
            newInputGroup.className = 'input-group mb-2';
            newInputGroup.innerHTML = `
                <input type="text" class="form-control feishu-table-id-input" placeholder="输入 Table ID">
                 <button class="btn btn-outline-danger remove-feishu-table-id-btn" type="button">移除</button>
            `;
            feishuTableIdsContainer.appendChild(newInputGroup);
        }

        // Remove Feishu Table ID input
        function handleRemoveFeishuTableId(event) {
            if (event.target.classList.contains('remove-feishu-table-id-btn')) {
                event.target.closest('.input-group').remove();
            }
        }

        // New function: Add new Feishu Add Target Table ID input
        function handleAddFeishuAddTargetId() {
            const newInputGroup = document.createElement('div');
            newInputGroup.className = 'input-group mb-2';

            const inputField = document.createElement('input');
            inputField.type = 'text';
            inputField.className = 'form-control feishu-add-target-id-input';
            inputField.placeholder = '输入新增专用 Table ID';

            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn btn-outline-danger remove-feishu-add-target-id-btn';
            removeButton.textContent = '移除'; // Use textContent for button text

            newInputGroup.appendChild(inputField);
            newInputGroup.appendChild(removeButton);

            feishuAddTargetIdsContainer.appendChild(newInputGroup);
        }

        // New function: Remove Feishu Add Target Table ID input
        function handleRemoveFeishuAddTargetId(event) {
            if (event.target.classList.contains('remove-feishu-add-target-id-btn')) {
                // Prevent removing the last input field if desired, or just remove
                const parent = event.target.closest('.input-group');
                const container = event.target.closest('#feishu-add-target-ids-container');
                // Optional: Keep at least one input field
                // if (container && container.querySelectorAll('.input-group').length > 1) {
                parent.remove();
                // } else {
                //     alert('至少需要一个新增目标 Table ID 输入框 (可以留空)。');
                // }
            }
        }

        // Update post-processing select options based on target columns
        function updatePostProcessSelects() {
            const currentColumns = getTargetColumns();
            // console.log("Updating post-process selects with columns:", currentColumns);

            // Re-query selects inside the function
            document.querySelectorAll('.post-process-select').forEach(select => {
                const currentVal = select.value;
                const selectName = select.name;
                let defaultValue = null;

                // Find default value for this specific select based on its name
                if (defaultPostProcessingCols) {
                    for (const checkKey in defaultPostProcessingCols) {
                        // Check if the key exists and is an object before accessing nested property
                        if (defaultPostProcessingCols.hasOwnProperty(checkKey) && typeof defaultPostProcessingCols[checkKey] === 'object' && defaultPostProcessingCols[checkKey] !== null) {
                            if (defaultPostProcessingCols[checkKey].hasOwnProperty(selectName)) {
                                defaultValue = defaultPostProcessingCols[checkKey][selectName];
                                break; // Found the default for this select, exit inner loop
                            }
                        }
                    }
                }
                // console.log(`Select ${selectName} - Current: ${currentVal}, Default: ${defaultValue}`);

                // Clear existing options (keep placeholder)
                const placeholderOption = select.options[0]; // Keep the first option (placeholder)
                select.innerHTML = ''; // Clear all options
                if (placeholderOption) {
                    select.appendChild(placeholderOption); // Re-add the placeholder if it existed
                }

                // Add new options from currentColumns
                currentColumns.forEach(colName => {
                    const option = new Option(colName, colName);
                    select.add(option);
                });

                // Set selected value: Prioritize current value if valid, then default value if valid, else reset to placeholder
                let valueToSet = ""; // Default to placeholder value
                if (currentColumns.includes(currentVal)) {
                    valueToSet = currentVal;
                } else if (defaultValue && currentColumns.includes(defaultValue)) {
                    valueToSet = defaultValue;
                }
                select.value = valueToSet;
                // console.log(`Select ${selectName} set to: ${select.value}`);
            });
        }

        // Handle change event for post-processing checkboxes
        function handlePostCheckboxChange(event) {
            const checkbox = event.target;
            const targetSelectIds = checkbox.dataset.targetSelects;
            if (targetSelectIds) {
                targetSelectIds.split(',').forEach(selectId => {
                    const selectElement = document.querySelector(selectId.trim());
                    if (selectElement) {
                        // Find the container relative to the select element more robustly
                        // Assumes container ID follows pattern: selectId + '-container'
                        const containerId = selectId.substring(1) + '-container'; // remove '#' and add suffix
                        const container = document.getElementById(containerId);
                        if (container) {
                            container.style.display = checkbox.checked ? 'block' : 'none';
                        } else {
                            console.warn("Could not find container with ID:", containerId, "for select:", selectId);
                            // Fallback: Try finding closest parent with 'mt-2' class, less reliable
                            const fallbackContainer = selectElement.closest('.mt-2');
                            if (fallbackContainer) {
                                fallbackContainer.style.display = checkbox.checked ? 'block' : 'none';
                                console.log("Used fallback container logic for", selectId);
                            } else {
                                console.warn("Could not find any container for select:", selectId);
                            }
                        }
                    } else {
                        console.warn("Could not find select element:", selectId);
                    }
                });
            }
        }

        // Display the names of selected files
        function displaySelectedFiles() {
            selectedFilesListDiv.innerHTML = '';
            if (fileInput.files.length > 0) {
                const list = document.createElement('ul');
                list.className = 'list-unstyled mb-0 small'; // Added small class
                for (const file of fileInput.files) {
                    const listItem = document.createElement('li');
                    const fileSize = (file.size / 1024).toFixed(1);
                    listItem.textContent = `${file.name} (${fileSize} KB)`;
                    list.appendChild(listItem);
                }
                selectedFilesListDiv.appendChild(list);
            } else {
                selectedFilesListDiv.textContent = '尚未选择文件';
            }
        }

        // 辅助函数：HTML转义
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') {
                if (unsafe === null || unsafe === undefined) return '';
                try {
                    unsafe = String(unsafe);
                } catch (e) {
                    console.warn('Failed to convert value to string for escaping:', unsafe);
                    return '[非字符串]'; // Fallback for complex objects
                }
            }
            // Ensure it is actually a string before calling replace
            if (typeof unsafe === 'string') {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            } else {
                // Should not happen due to checks above, but as a final fallback
                return '[转换错误]';
            }
        }

        // 文件大小格式化辅助函数
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // 为直接导入添加同步到飞书的处理函数
        async function handleDirectSyncToFeishu() {
            if (!currentDirectImportTaskId) {
                alert('没有有效的任务ID，请先上传文件');
                return;
            }

            if (!confirm('确定要同步到飞书多维表格吗？此操作无法撤销。')) {
                return;
            }

            directSyncFeishuBtn.disabled = true;
            directSyncStatusSpan.textContent = '同步中...';

            try {
                const response = await fetch(`/sync_to_feishu/${currentDirectImportTaskId}`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (response.ok && result.success) {
                    console.log('同步成功:', result);
                    directSyncStatusSpan.textContent = result.message || '同步成功！';
                    directSyncStatusSpan.className = 'ms-2 text-success';

                    // 同步成功后重置
                    currentDirectImportTaskId = null;
                } else {
                    console.error('同步失败:', result.error);
                    directSyncStatusSpan.textContent = `同步失败: ${result.error || '未知错误'}`;
                    directSyncStatusSpan.className = 'ms-2 text-danger';
                    directSyncFeishuBtn.disabled = false;
                }
            } catch (error) {
                console.error('同步到飞书时发生网络错误:', error);
                directSyncStatusSpan.textContent = '同步时发生网络错误。';
                directSyncStatusSpan.className = 'ms-2 text-danger';
                directSyncFeishuBtn.disabled = false;
            }
        }

    </script>
    <!-- 引入 Bootstrap 的 JavaScript 包 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>