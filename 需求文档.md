# 表格数据清洗与飞书同步工具 - 初始需求文档

## 1. 项目目标

开发一个 Web 应用工具，旨在自动化处理、清洗和标准化表格数据（Excel/CSV），利用大型语言模型（LLM）提取关键信息，并将其与飞书多维表格数据进行整合、校验和同步。该工具需提供用户友好的界面来管理整个流程，包括配置、文件处理、人工审核和数据同步。

## 2. 功能需求

### 2.1 文件上传与处理启动
*   **FR1.1:** 用户能够通过 Web 界面上传一个或多个 Excel (`.xlsx`, `.xls`) 或 CSV (`.csv`) 文件。
*   **FR1.2:** 系统应显示用户已选择的文件列表。
*   **FR1.3:** 用户能够触发数据处理流程。

### 2.2 配置管理
*   **FR2.1:** 提供 Web 界面，允许用户配置 LLM 处理参数：
    *   目标列名 (最终输出需要包含的列，支持动态增删)
    *   DeepSeek API Key
    *   批处理大小 (Batch Size)
    *   最大完成 Token 数
    *   API 超时时间
*   **FR2.2:** 提供 Web 界面，允许用户配置飞书集成参数：
    *   飞书 App ID
    *   飞书 App Secret
    *   飞书 Base App Token
    *   来源飞书 Table ID(s) (用于读取数据和更新/删除，支持多个)
    *   目标飞书 Table ID(s) (用于新增写入，支持多个，按顺序检查容量)
*   **FR2.3:** 提供 Web 界面，允许用户配置后处理操作：
    *   选择是否进行"校验重复手机号"，并指定用于校验的"电话"列。
    *   选择是否进行"校验手机号+公司名重复 & 关联公司名(LLM)检查"，并指定"电话"列和"公司"列。
    *   选择是否进行"校验手机号格式"，并指定用于校验的"电话"列。
*   **FR2.4:** 系统应加载 `config.json` 文件作为默认配置。
*   **FR2.5:** 用户能够将当前界面上的所有配置保存为新的默认值（写入 `config.json`）。

### 2.3 数据处理与整合 (后台)
*   **FR3.1:** (LLM 处理) 系统接收上传的文件，按批次调用 DeepSeek LLM API，根据用户配置的"目标列名"提取和标准化数据。
    *   自动为 LLM 处理后的数据添加 `local_row_id` (UUID)。
    *   自动为 LLM 处理后的数据添加 `来源` 列，值为原始文件名。
    *   处理 API 错误和超时，包含重试机制。
*   **FR3.2:** (飞书读取) 系统根据配置，从指定的"来源飞书 Table ID(s)" 拉取所有记录，包含 `record_id`。
*   **FR3.3:** (数据合并) 系统将 LLM 处理后的数据和从飞书拉取的数据合并。
    *   合并时确保包含所有"目标列名"以及 `record_id`, `local_row_id`, `来源` 和后处理可能需要的列（如 `备注`, `关联公司名称(LLM)`）。
    *   对合并后的数据进行列标准化。
*   **FR3.4:** (后处理) 对合并后的数据执行用户选择的后处理校验：
    *   (清理) 对所有字符串列进行前后空格和换行符清理。
    *   (校验1) 检查重复手机号，在"备注"列添加标记。
    *   (校验2) 检查手机号+公司名重复，在"备注"列添加标记。
    *   (校验3) 对于仅手机号重复但公司名不同的情况，调用 LLM API 判断公司名是否关联，并将关联的公司名填入"关联公司名称(LLM)"列。
    *   (校验4) 校验手机号格式是否为11位数字，在"备注"列添加标记。

### 2.4 进度反馈与结果下载
*   **FR4.1:** 处理过程中，界面应实时显示处理状态和进度百分比。
*   **FR4.2:** 处理完成后，提供最终结果文件(`final_[task_id].xlsx`)的下载链接。

### 2.5 人工审核与调整
*   **FR5.1:** 用户下载最终结果文件后，可在本地进行手动修改和调整。
*   **FR5.2:** 用户能够通过界面上传修改后的 Excel 文件。

### 2.6 差异比较
*   **FR6.1:** 用户上传修改后的文件后，能够触发差异比较功能。
*   **FR6.2:** 系统比较原始的最终结果文件和用户上传的修改后文件，以 `local_row_id` 作为主键。
*   **FR6.3:** 在界面上清晰地展示差异：
    *   新增的行（高亮绿色）。
    *   删除的行（高亮红色并带删除线）。
    *   修改的行（高亮黄色），并标出具体修改的单元格及其旧值（例如通过 tooltip 或不同颜色）。
*   **FR6.4:** 提供差异结果的汇总信息（新增、删除、修改的数量）。
*   **FR6.5:** 对差异结果表格提供分页功能，并允许用户选择每页显示的行数。

### 2.7 同步回飞书
*   **FR7.1:** 用户在确认差异无误后，能够触发同步到飞书的功能。
*   **FR7.2:** 系统根据差异比较结果执行以下操作：
    *   **新增：** 将用户编辑文件中 `record_id` 为空的行，作为新记录添加到配置的"目标飞书 Table ID(s)"中（按顺序检查容量）。
    *   **更新：** 将差异结果中状态为 "Modified" 的行，根据 `record_id` 更新到对应的"来源飞书 Table ID"中的第一张表。仅更新发生变化的字段。
    *   **删除：** 将差异结果中状态为 "Deleted" 的行，根据 `record_id` 从对应的"来源飞书 Table ID"中的第一张表删除。
*   **FR7.3:** 系统处理飞书 API 的批量操作（新增、更新、删除）。
*   **FR7.4:** 在界面上反馈同步操作的结果（成功数量、失败数量、错误信息）。

## 3. 非功能需求

*   **NFR1:** **错误处理:** 系统应能妥善处理文件读取错误、API 调用错误、配置错误、网络错误等，并向用户提供有意义的反馈。
*   **NFR2:** **并发处理:** 系统应能支持多个用户同时上传和处理文件（通过为每个任务创建独立线程和目录实现）。
*   **NFR3:** **安全性:** API Key 等敏感信息应妥善处理（例如，密码输入框、不在前端明文存储敏感默认值）。在文件下载和路径处理时注意防止路径遍历。
*   **NFR4:** **易用性:** Web 界面应清晰、直观，提供必要的操作说明。 