# 表格数据清洗与飞书同步工具 - 需求文档

## 1. 项目目标

开发一个 Web 应用工具，旨在自动化处理、清洗和标准化表格数据（Excel/CSV），利用大型语言模型（LLM）提取关键信息，并将其与飞书多维表格数据进行整合、校验和同步。该工具需提供用户友好的界面来管理整个流程，包括配置、文件处理、人工审核和数据同步。

## 2. 功能需求

### 2.1 文件上传与处理启动
*   **FR1.1:** 用户能够通过 Web 界面上传一个或多个 Excel (`.xlsx`, `.xls`) 或 CSV (`.csv`) 文件。
*   **FR1.2:** 系统应显示用户已选择的文件列表。
*   **FR1.3:** 用户能够触发数据处理流程。
*   **FR1.4:** 用户可以选择不同的处理模式：
    *   完整流程（处理清洗 + 审核 + 同步）
    *   直接导入模式（将格式合适的文件直接导入到飞书多维表格）

### 2.2 配置管理
*   **FR2.1:** 提供 Web 界面，允许用户配置 LLM 处理参数：
    *   目标列名 (最终输出需要包含的列，支持动态增删)
    *   DeepSeek API Key
    *   批处理大小 (Batch Size)
    *   最大完成 Token 数
    *   API 超时时间
*   **FR2.2:** 提供 Web 界面，允许用户配置飞书集成参数：
    *   飞书 App ID
    *   飞书 App Secret
    *   飞书 Base App Token
    *   来源飞书 Table ID(s) (用于读取数据和更新/删除，支持多个)
    *   目标飞书 Table ID(s) (用于新增写入，支持多个，按顺序检查容量)
*   **FR2.3:** 提供 Web 界面，允许用户配置后处理操作：
    *   选择是否进行"校验重复手机号"，并指定用于校验的"电话"列。
    *   选择是否进行"校验手机号+公司名重复 & 关联公司名(LLM)检查"，并指定"电话"列和"公司"列。
    *   选择是否进行"校验手机号格式"，并指定用于校验的"电话"列。
*   **FR2.4:** 系统应加载 `config.json` 文件作为默认配置。
*   **FR2.5:** 用户能够将当前界面上的所有配置保存为新的默认值（写入 `config.json`）。

### 2.3 数据处理与整合 (后台)
*   **FR3.1:** (LLM 处理) 系统接收上传的文件，按批次调用 DeepSeek LLM API，根据用户配置的"目标列名"提取和标准化数据。
    *   自动为 LLM 处理后的数据添加 `local_row_id` (UUID)。
    *   自动为 LLM 处理后的数据添加 `来源` 列，值为原始文件名。
    *   处理 API 错误和超时，包含重试机制。
*   **FR3.2:** (飞书读取) 系统根据配置，从指定的"来源飞书 Table ID(s)" 拉取所有记录，包含 `record_id`。
*   **FR3.3:** (数据合并) 系统将 LLM 处理后的数据和从飞书拉取的数据合并。
    *   合并时确保包含所有"目标列名"以及 `record_id`, `local_row_id`, `来源` 和后处理可能需要的列（如 `备注`, `关联公司名称(LLM)`）。
    *   对合并后的数据进行列标准化。
    *   **FR3.3.1:** (飞书数据列过滤) 从飞书拉取的数据中仅保留必要的系统列（`record_id`, `table_id`）和目标列名中指定的业务列，过滤掉其他飞书特有列（如"一级行业", "二级行业", "创建日期"等）。
*   **FR3.4:** (后处理) 对合并后的数据执行用户选择的后处理校验：
    *   (清理) 对所有字符串列进行前后空格和换行符清理。
    *   (校验1) 检查重复手机号，在"备注"列添加标记。
    *   (校验2) 检查手机号+公司名重复，在"备注"列添加标记。
    *   (校验3) 对于仅手机号重复但公司名不同的情况，调用 LLM API 判断公司名是否关联，并将关联的公司名填入"关联公司名称(LLM)"列。
    *   (校验4 - 提前) 校验手机号格式是否为11位数字，在"备注"列添加标记。
    *   **(新增子步骤) 处理不相关的重复手机号记录:**
        *   识别出手机号重复，但公司名称不同，且步骤 (校验3) 中 LLM 判断这些公司*不相关*（或未进行关联检查）的数据组。
        *   **如果组内所有记录的 `record_id` 均为空:** 选择其中一条记录保留，将其余记录丢弃。将组内所有不同的非空"企业名称"和"来源"分别用分号（;）拼接，更新到保留记录的对应字段。此保留记录将被归类到"新增"Sheet页。
        *   **如果组内至少有一条记录的 `record_id` 非空:** 选择其中一条 `record_id` 非空的记录保留（优先选择信息较完整的记录），将其余记录丢弃。将组内所有不同的非空"企业名称"和"来源"分别用分号（;）拼接，更新到保留记录的对应字段。此保留记录将被归类到"更新"Sheet页。

### 2.4 进度反馈与结果下载
*   **FR4.1:** 处理过程中，界面应实时显示处理状态和进度百分比。
*   **FR4.2:** 处理完成后，提供最终结果文件(`final_[task_id].xlsx`)的下载链接。

### 2.5 人工审核与调整
*   **FR5.1:** 用户下载最终结果文件后，可在本地进行手动修改和调整。
*   **FR5.2:** 用户能够通过界面上传修改后的 Excel 文件。
*   **FR5.3:** 用户可以选择跳过人工审核步骤，直接进行数据同步。

### 2.6 同步到飞书
*   **FR6.1:** 用户可以将处理后的数据同步到飞书多维表格。
*   **FR6.2:** 系统会直接从多Sheet页Excel文件中读取不同Sheet页的数据：
    *   **新增：** 从"新增"Sheet页读取`record_id`为空的行，作为新记录添加到配置的"目标飞书 Table ID(s)"中。
    *   **更新：** 从"更新"Sheet页读取数据，根据`record_id`更新到对应的飞书表格中。
*   **FR6.3:** 系统处理飞书 API 的批量操作（新增、更新）。
*   **FR6.4:** 在界面上反馈同步操作的结果（成功数量、失败数量、错误信息）。
*   **FR6.5:** 支持无需经过前期处理步骤，直接将符合格式要求的文件导入到飞书多维表格。

### 2.7 历史记录管理
*   **FR7.1:** 系统提供历史记录页面，显示最近10次处理任务的详细信息。
*   **FR7.2:** 历史记录包含以下信息：
    *   任务ID
    *   上传时间
    *   上传的文件列表
    *   处理后的结果文件（可点击下载）
    *   操作类型（上传并整理/导入到多维表格）
    *   处理状态（成功/失败）
*   **FR7.3:** 用户可以从历史记录中下载任何处理过的文件。
*   **FR7.4:** 系统自动清理早期记录，仅保留最近10次任务数据。

### 2.8 独立操作流程
*   **FR8.1:** 系统支持灵活的操作流程，不要求严格的先后顺序。
*   **FR8.2:** 用户可以选择以下任意独立操作路径：
    *   上传文件 → LLM处理 → 后处理 → 下载结果 → 同步到飞书
    *   上传符合格式的文件 → 直接导入到飞书
*   **FR8.3:** 系统为每个操作路径提供清晰的界面引导。

## 3. 非功能需求

*   **NFR1:** **错误处理:** 系统应能妥善处理文件读取错误、API 调用错误、配置错误、网络错误等，并向用户提供有意义的反馈。
*   **NFR2:** **并发处理:** 系统应能支持多个用户同时上传和处理文件（通过为每个任务创建独立线程和目录实现）。
*   **NFR3:** **安全性:** API Key 等敏感信息应妥善处理（例如，密码输入框、不在前端明文存储敏感默认值）。在文件下载和路径处理时注意防止路径遍历。
*   **NFR4:** **易用性:** Web 界面应清晰、直观，提供必要的操作说明。 
*   **NFR5:** **灵活性:** 系统支持不同的工作流程和操作模式，用户可以根据需要选择完整流程或简化流程。 